<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è²¡å‹™åŠ©æ‰‹</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <!-- å°èˆªæ¬„ -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo">
                ğŸ¤– AI è²¡å‹™åŠ©æ‰‹
            </div>
            <ul class="nav-links">
                <li><a href="/" class="active">ğŸ“Š å„€è¡¨æ¿</a></li>
                <li><a href="/analysis">ğŸ“ˆ æŠ€è¡“åˆ†æ</a></li>
                <li><a href="/portfolio">ğŸ’¼ æŠ•è³‡çµ„åˆ</a></li>
                <li><a href="/risk">âš ï¸ é¢¨éšªåˆ†æ</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <!-- å¸‚å ´æ‘˜è¦ -->
        <section style="margin-bottom: 2rem;">
            <h2 style="margin-bottom: 1rem; font-size: 1.5rem;">ğŸŒ å¸‚å ´æ¦‚è¦½</h2>
            <div class="grid grid-4">
                {% for name, data in market_summary.items() %}
                <div class="market-card fade-in">
                    <div class="market-name">{{ name }}</div>
                    {% if data.error is not defined %}
                    <div class="market-price">{{ "{:,.2f}".format(data.price) }}</div>
                    <div class="market-change {{ 'positive' if data.change_pct >= 0 else 'negative' }}">
                        {{ "â–²" if data.change_pct >= 0 else "â–¼" }}
                        {{ "{:+.2f}".format(data.change) }} ({{ "{:+.2f}".format(data.change_pct) }}%)
                    </div>
                    {% else %}
                    <div class="market-price">--</div>
                    <div class="market-change">ç„¡æ³•å–å¾—è³‡æ–™</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- æŠ•è³‡çµ„åˆæ‘˜è¦ -->
        <section style="margin-bottom: 2rem;">
            <h2 style="margin-bottom: 1rem; font-size: 1.5rem;">ğŸ’° æŠ•è³‡çµ„åˆæ‘˜è¦</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">ç¸½æˆæœ¬</div>
                    <div class="stat-value">${{ "{:,.2f}".format(total_cost) }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ç¸½å¸‚å€¼</div>
                    <div class="stat-value">${{ "{:,.2f}".format(total_value) }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ç¸½æç›Š</div>
                    <div class="stat-value {{ 'positive' if total_profit >= 0 else 'negative' }}">
                        {{ "+" if total_profit >= 0 else "" }}${{ "{:,.2f}".format(total_profit) }}
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å ±é…¬ç‡</div>
                    <div class="stat-value {{ 'positive' if total_profit_pct >= 0 else 'negative' }}">
                        {{ "{:+.2f}".format(total_profit_pct) }}%
                    </div>
                </div>
            </div>
        </section>

        <!-- æŒè‚¡åˆ—è¡¨ -->
        <section>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“‹ æŒè‚¡æ˜ç´°</h3>
                    <button class="btn btn-primary" onclick="openAddModal()">
                        â• æ–°å¢æŒè‚¡
                    </button>
                </div>

                {% if portfolio %}
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>è‚¡ç¥¨</th>
                                <th>è‚¡æ•¸</th>
                                <th>å‡åƒ¹</th>
                                <th>ç¾åƒ¹</th>
                                <th>æˆæœ¬</th>
                                <th>å¸‚å€¼</th>
                                <th>æç›Š</th>
                                <th>å ±é…¬ç‡</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in portfolio %}
                            <tr class="fade-in">
                                <td>
                                    <div style="font-weight: 600;">{{ item.symbol }}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">{{ item.name }}</div>
                                </td>
                                <td>{{ "{:,.2f}".format(item.shares) }}</td>
                                <td>${{ "{:,.2f}".format(item.avg_cost) }}</td>
                                <td>${{ "{:,.2f}".format(item.current_price) }}</td>
                                <td>${{ "{:,.2f}".format(item.cost) }}</td>
                                <td>${{ "{:,.2f}".format(item.value) }}</td>
                                <td class="{{ 'positive' if item.profit >= 0 else 'negative' }}"
                                    style="font-weight: 600;">
                                    {{ "+" if item.profit >= 0 else "" }}${{ "{:,.2f}".format(item.profit) }}
                                </td>
                                <td>
                                    <span
                                        class="badge {{ 'badge-success' if item.profit_pct >= 0 else 'badge-danger' }}">
                                        {{ "{:+.2f}".format(item.profit_pct) }}%
                                    </span>
                                </td>
                                <td>
                                    <a href="/analysis?symbol={{ item.symbol }}" class="btn btn-outline btn-sm">åˆ†æ</a>
                                    <button class="btn btn-danger btn-sm"
                                        onclick="deleteHolding({{ item.id }})">åˆªé™¤</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“­</div>
                    <p>å°šç„¡æŒè‚¡è³‡æ–™ï¼Œé»æ“Šã€Œæ–°å¢æŒè‚¡ã€é–‹å§‹è¿½è¹¤æ‚¨çš„æŠ•è³‡çµ„åˆ</p>
                </div>
                {% endif %}
            </div>
        </section>
    </div>

    <!-- æ–°å¢æŒè‚¡ Modal -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>â• æ–°å¢æŒè‚¡</h3>
                <button class="modal-close" onclick="closeAddModal()">&times;</button>
            </div>
            <form id="addForm" onsubmit="addHolding(event)">
                <div class="form-group">
                    <label class="form-label">è‚¡ç¥¨ä»£ç¢¼</label>
                    <input type="text" class="form-input" id="symbol" placeholder="ä¾‹å¦‚: AAPL æˆ– 2330.TW" required>
                </div>
                <div class="form-group">
                    <label class="form-label">è‚¡æ•¸</label>
                    <input type="number" class="form-input" id="shares" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">å¹³å‡æˆæœ¬</label>
                    <input type="number" class="form-input" id="avg_cost" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">å¹£åˆ¥</label>
                    <select class="form-input" id="currency">
                        <option value="USD">USD ç¾å…ƒ</option>
                        <option value="TWD">TWD å°å¹£</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    ç¢ºèªæ–°å¢
                </button>
            </form>
        </div>
    </div>

    <footer class="footer">
        <p>ğŸ¤– AI è²¡å‹™åŠ©æ‰‹ | è³‡æ–™ä¾†æº: Yahoo Finance | æ›´æ–°æ™‚é–“: {{ now.strftime('%Y-%m-%d %H:%M') }}</p>
        <p style="margin-top: 0.5rem;">âš ï¸ æœ¬ç³»çµ±åƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°</p>
    </footer>

    <script>
        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
        }

        async function addHolding(event) {
            event.preventDefault();

            const data = {
                symbol: document.getElementById('symbol').value.toUpperCase(),
                shares: document.getElementById('shares').value,
                avg_cost: document.getElementById('avg_cost').value,
                currency: document.getElementById('currency').value
            };

            try {
                const response = await fetch('/api/portfolio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥è‚¡ç¥¨ä»£ç¢¼æ˜¯å¦æ­£ç¢º');
                }
            } catch (error) {
                alert('ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
            }
        }

        async function deleteHolding(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æŒè‚¡å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/portfolio/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    window.location.reload();
                }
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—: ' + error.message);
            }
        }
    </script>
</body>

</html>