<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•è³‡çµ„åˆ - AI è²¡å‹™åŠ©æ‰‹</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <!-- å°èˆªæ¬„ -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo">ğŸ¤– AI è²¡å‹™åŠ©æ‰‹</div>
            <ul class="nav-links">
                <li><a href="/">ğŸ“Š å„€è¡¨æ¿</a></li>
                <li><a href="/analysis">ğŸ“ˆ æŠ€è¡“åˆ†æ</a></li>
                <li><a href="/portfolio" class="active">ğŸ’¼ æŠ•è³‡çµ„åˆ</a></li>
                <li><a href="/risk">âš ï¸ é¢¨éšªåˆ†æ</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="grid grid-2" style="gap: 2rem;">
            <!-- æŒè‚¡ç®¡ç† -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ’¼ æˆ‘çš„æŒè‚¡</h3>
                    <button class="btn btn-primary btn-sm" onclick="openAddModal()">â• æ–°å¢</button>
                </div>

                {% if holdings %}
                <div style="max-height: 400px; overflow-y: auto;">
                    {% for holding in holdings %}
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border);">
                        <div>
                            <div style="font-weight: 600;">{{ holding.symbol }}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                {{ holding.shares }} è‚¡ @ ${{ "{:,.2f}".format(holding.avg_cost) }}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <a href="/analysis?symbol={{ holding.symbol }}" class="btn btn-outline btn-sm">åˆ†æ</a>
                            <button class="btn btn-danger btn-sm" onclick="deleteHolding({{ holding.id }})">Ã—</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <p>å°šç„¡æŒè‚¡</p>
                </div>
                {% endif %}
            </div>

            <!-- è¿½è¹¤æ¸…å–® -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ‘€ è¿½è¹¤æ¸…å–®</h3>
                    <button class="btn btn-primary btn-sm" onclick="openWatchlistModal()">â• æ–°å¢</button>
                </div>

                <div id="watchlist" style="max-height: 400px; overflow-y: auto;">
                    è¼‰å…¥ä¸­...
                </div>
            </div>
        </div>

        <!-- äº¤æ˜“è¨˜éŒ„ -->
        <section style="margin-top: 2rem;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“ æœ€è¿‘äº¤æ˜“è¨˜éŒ„</h3>
                </div>

                {% if transactions %}
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>è‚¡ç¥¨</th>
                                <th>é¡å‹</th>
                                <th>è‚¡æ•¸</th>
                                <th>åƒ¹æ ¼</th>
                                <th>ç¸½é¡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tx in transactions %}
                            <tr>
                                <td>{{ tx.transaction_date[:10] }}</td>
                                <td>{{ tx.symbol }}</td>
                                <td>
                                    <span class="badge {{ 'badge-success' if tx.type == 'BUY' else 'badge-danger' }}">
                                        {{ 'è²·å…¥' if tx.type == 'BUY' else 'è³£å‡º' }}
                                    </span>
                                </td>
                                <td>{{ "{:,.2f}".format(tx.shares) }}</td>
                                <td>${{ "{:,.2f}".format(tx.price) }}</td>
                                <td>${{ "{:,.2f}".format(tx.total) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    å°šç„¡äº¤æ˜“è¨˜éŒ„
                </div>
                {% endif %}
            </div>
        </section>

        <!-- å¿«é€Ÿæ“ä½œ -->
        <section style="margin-top: 2rem;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">âš¡ å¿«é€Ÿæ“ä½œ</h3>
                </div>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="generateReport()">
                        ğŸ“Š ç”Ÿæˆæ¯æ—¥å ±å‘Š
                    </button>
                    <button class="btn btn-outline" onclick="getRecommendations()">
                        ğŸ¤– å–å¾— AI å»ºè­°
                    </button>
                </div>
                <div id="quickResult" style="margin-top: 1rem;"></div>
            </div>
        </section>
    </div>

    <!-- æ–°å¢æŒè‚¡ Modal -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>â• æ–°å¢æŒè‚¡</h3>
                <button class="modal-close" onclick="closeAddModal()">&times;</button>
            </div>
            <form onsubmit="addHolding(event)">
                <div class="form-group">
                    <label class="form-label">è‚¡ç¥¨ä»£ç¢¼</label>
                    <input type="text" class="form-input" id="symbol" placeholder="ä¾‹å¦‚: AAPL æˆ– 2330.TW" required>
                </div>
                <div class="form-group">
                    <label class="form-label">è‚¡æ•¸</label>
                    <input type="number" class="form-input" id="shares" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">å¹³å‡æˆæœ¬</label>
                    <input type="number" class="form-input" id="avg_cost" step="0.01" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ç¢ºèªæ–°å¢</button>
            </form>
        </div>
    </div>

    <!-- æ–°å¢è¿½è¹¤ Modal -->
    <div class="modal" id="watchlistModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ‘€ æ–°å¢è¿½è¹¤</h3>
                <button class="modal-close" onclick="closeWatchlistModal()">&times;</button>
            </div>
            <form onsubmit="addToWatchlist(event)">
                <div class="form-group">
                    <label class="form-label">è‚¡ç¥¨ä»£ç¢¼</label>
                    <input type="text" class="form-input" id="watchSymbol" placeholder="ä¾‹å¦‚: NVDA æˆ– 2454.TW" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ç¢ºèªæ–°å¢</button>
            </form>
        </div>
    </div>

    <footer class="footer">
        <p>ğŸ¤– AI è²¡å‹™åŠ©æ‰‹ | è³‡æ–™ä¾†æº: Yahoo Finance</p>
    </footer>

    <script>
        // è¼‰å…¥è¿½è¹¤æ¸…å–®
        async function loadWatchlist() {
            const response = await fetch('/api/watchlist');
            const items = await response.json();
            const container = document.getElementById('watchlist');

            if (items.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">å°šç„¡è¿½è¹¤è‚¡ç¥¨</div>';
                return;
            }

            container.innerHTML = items.map(item => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border);">
                    <div>
                        <div style="font-weight: 600;">${item.symbol}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${item.name || ''}</div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="/analysis?symbol=${item.symbol}" class="btn btn-outline btn-sm">åˆ†æ</a>
                        <button class="btn btn-danger btn-sm" onclick="removeFromWatchlist('${item.symbol}')">Ã—</button>
                    </div>
                </div>
            `).join('');
        }

        // Modal æ§åˆ¶
        function openAddModal() { document.getElementById('addModal').classList.add('active'); }
        function closeAddModal() { document.getElementById('addModal').classList.remove('active'); }
        function openWatchlistModal() { document.getElementById('watchlistModal').classList.add('active'); }
        function closeWatchlistModal() { document.getElementById('watchlistModal').classList.remove('active'); }

        // æ–°å¢æŒè‚¡
        async function addHolding(event) {
            event.preventDefault();
            const data = {
                symbol: document.getElementById('symbol').value.toUpperCase(),
                shares: document.getElementById('shares').value,
                avg_cost: document.getElementById('avg_cost').value
            };
            await fetch('/api/portfolio', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            window.location.reload();
        }

        // åˆªé™¤æŒè‚¡
        async function deleteHolding(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            await fetch(`/api/portfolio/${id}`, { method: 'DELETE' });
            window.location.reload();
        }

        // æ–°å¢è¿½è¹¤
        async function addToWatchlist(event) {
            event.preventDefault();
            const symbol = document.getElementById('watchSymbol').value.toUpperCase();
            await fetch('/api/watchlist', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol })
            });
            closeWatchlistModal();
            loadWatchlist();
        }

        // ç§»é™¤è¿½è¹¤
        async function removeFromWatchlist(symbol) {
            await fetch(`/api/watchlist/${symbol}`, { method: 'DELETE' });
            loadWatchlist();
        }

        // ç”Ÿæˆå ±å‘Š
        async function generateReport() {
            const result = document.getElementById('quickResult');
            result.innerHTML = '<div class="loading"></div> ç”Ÿæˆä¸­...';

            const response = await fetch('/api/report/generate');
            const report = await response.json();

            result.innerHTML = `
                <div class="alert" style="background: var(--bg-dark); border: 1px solid var(--border);">
                    <p><strong>âœ… å ±å‘Šå·²ç”Ÿæˆ</strong></p>
                    <p>æŠ•çµ„å¸‚å€¼: $${report.portfolio_summary.total_value.toLocaleString()}</p>
                    <p>ç¸½å ±é…¬: ${report.portfolio_summary.total_return_pct.toFixed(2)}%</p>
                </div>
            `;
        }

        // å–å¾—å»ºè­°
        async function getRecommendations() {
            const result = document.getElementById('quickResult');
            result.innerHTML = '<div class="loading"></div> åˆ†æä¸­...';

            const response = await fetch('/api/recommendations');
            const recs = await response.json();

            result.innerHTML = `
                <div style="display: grid; gap: 0.5rem;">
                    ${recs.map(r => `
                        <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-dark); border-radius: 8px;">
                            <span>${r.symbol}</span>
                            <span class="badge ${r.recommendation === 'BUY' ? 'badge-success' : (r.recommendation === 'SELL' ? 'badge-danger' : 'badge-warning')}">
                                ${r.recommendation_zh}
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // åˆå§‹åŒ–
        loadWatchlist();
    </script>
</body>

</html>